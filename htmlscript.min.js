class HtmlScript{constructor(){this.scopes=[new Map],this.functions=new Map,this.callStack=[],this.init()}getVariable(e){for(let t=this.scopes.length-1;t>=0;t--)if(this.scopes[t].has(e))return this.scopes[t].get(e)}setVariable(e,t,r=!0){r?this.scopes[this.scopes.length-1].set(e,t):this.scopes[0].set(e,t)}evaluate(e){try{return this.safeEvaluate(e)}catch(t){throw console.error("Evaluation error:",e,t),t}}safeEvaluate(e){const t=this.tokenize(e),r=this.toPostfix(t);return this.evaluatePostfix(r)}tokenize(e){const t=[];let r=0;for(;r<e.length;){const s=e[r];if(/\s/.test(s))r++;else if(/[0-9]/.test(s)){let s="";for(;r<e.length&&/[0-9.]/.test(e[r]);)s+=e[r++];t.push({type:"number",value:parseFloat(s)})}else if(/[a-zA-Z_]/.test(s)){let s="";for(;r<e.length&&/[a-zA-Z0-9_]/.test(e[r]);)s+=e[r++];t.push({type:"identifier",value:s})}else{if(!"+-*/()^".includes(s))throw new Error(`Invalid token: ${s}`);t.push({type:"operator",value:s}),r++}}return t}toPostfix(e){const t=[],r=[],s={"^":4,"*":3,"/":3,"+":2,"-":2},i={"^":"right","*":"left","/":"left","+":"left","-":"left"};for(e.forEach((e=>{if("number"===e.type||"identifier"===e.type)t.push(e);else if("operator"===e.type)if("("===e.value)r.push(e);else if(")"===e.value){for(;r.length&&"("!==r[r.length-1].value;)t.push(r.pop());r.pop()}else{for(;r.length&&"("!==r[r.length-1].value&&(s[r[r.length-1].value]>s[e.value]||s[r[r.length-1].value]===s[e.value]&&"left"===i[e.value]);)t.push(r.pop());r.push(e)}}));r.length;)t.push(r.pop());return t}evaluatePostfix(e){const t=[];return e.forEach((e=>{if("number"===e.type)t.push(e.value);else if("identifier"===e.type){const r=this.getVariable(e.value);if(void 0===r)throw new Error(`Undefined variable: ${e.value}`);t.push(r)}else if("operator"===e.type){const r=t.pop(),s=t.pop();switch(e.value){case"+":t.push(s+r);break;case"-":t.push(s-r);break;case"*":t.push(s*r);break;case"/":t.push(s/r);break;case"^":t.push(Math.pow(s,r));break;default:throw new Error(`Invalid operator: ${e.value}`)}}})),t[0]}async processNode(e){if(1!==e.nodeType)return;const t=e.tagName.toLowerCase();if(this.callStack.push(t),this.callStack.length>50)throw new Error("Recursion depth exceeded");let r=!0;try{switch(t){case"store":this.processStore(e);break;case"man":this.processMan(e);break;case"calc":this.processCalc(e);break;case"if":await this.processIf(e);break;case"else":case"catch":default:r=!1;break;case"for":await this.processFor(e);break;case"while":await this.processWhile(e);break;case"func":this.processFunc(e);break;case"call":await this.processCall(e);break;case"scope":await this.processScope(e);break;case"input":this.processInput(e);break;case"output":this.processOutput(e);break;case"try":await this.processTry(e);break;case"import":await this.processImport(e);break;case"on":this.processOn(e);break;case"debug":this.processDebug(e);break;case"http":await this.processHttp(e);break;case"json":this.processJson(e);break;case"csv":this.processCsv(e);break;case"ini":this.processIni(e);break;case"xml":this.processXml(e);break;case"yml":case"yaml":this.processYml(e);break;case"break":throw new CustomBreakError;case"continue":throw new CustomContinueError}r||await this.processChildren(e)}catch(e){throw e instanceof CustomBreakError||e instanceof CustomContinueError||console.error("Error processing node:",t,e,"Stack:",this.callStack.join(" > ")),e}finally{this.callStack.pop()}}async processChildren(e){const t=Array.from(e.childNodes);for(const e of t)await this.processNode(e)}async processAll(){await this.processChildren(document.body)}processStore(e){const t=e.getAttribute("name"),r=e.getAttribute("value"),s=e.getAttribute("type"),i="false"!==e.getAttribute("local"),o=this.evaluate(r);if(s&&typeof o!==s)throw new Error(`Type mismatch for ${t}: expected ${s}, got ${typeof o}`);this.setVariable(t,o,i),e.remove()}processMan(e){const t=e.getAttribute("name"),r=e.getAttribute("operation"),s=e.getAttribute("type");let i,o=this.getVariable(t);if(void 0===o)throw new Error(`Variable ${t} not found`);if(r.startsWith(".")?(console.warn("Using unsafe eval for object manipulation"),i=new Function("val",`val${r}; return val;`)(o)):i=this.safeEvaluate(o+r),s&&typeof i!==s)throw new Error(`Type mismatch after manipulation for ${t}: expected ${s}, got ${typeof i}`);this.setVariable(t,i),e.remove()}processCalc(e){const t=e.getAttribute("expression"),r=e.getAttribute("type"),s=this.evaluate(t);if(r&&typeof s!==r)throw new Error(`Type mismatch in calc: expected ${r}, got ${typeof s}`);e.innerText=s}async processIf(e){const t=e.getAttribute("condition"),r=this.evaluate(t),s=e.nextElementSibling&&"else"===e.nextElementSibling.tagName.toLowerCase()?e.nextElementSibling:null;r?(await this.processChildren(e),e.replaceWith(...e.childNodes),s&&s.remove()):(e.remove(),s&&(await this.processChildren(s),s.replaceWith(...s.childNodes)))}async processFor(e){const t=e.getAttribute("init"),r=e.getAttribute("condition"),s=e.getAttribute("increment");if(t){const e=t.split("=");if(2===e.length){const t=e[0].trim(),r=this.evaluate(e[1].trim());this.setVariable(t,r)}else this.evaluate(t)}const i=e.cloneNode(!0);for(e.innerHTML="";this.evaluate(r);){const t=i.cloneNode(!0);try{await this.processChildren(t)}catch(e){if(e instanceof CustomBreakError)break;if(e instanceof CustomContinueError){this.evaluate(s);continue}throw e}e.appendChild(t),this.evaluate(s)}e.replaceWith(...e.childNodes)}async processWhile(e){const t=e.getAttribute("condition"),r=e.cloneNode(!0);for(e.innerHTML="";this.evaluate(t);){const t=r.cloneNode(!0);try{await this.processChildren(t)}catch(e){if(e instanceof CustomBreakError)break;if(e instanceof CustomContinueError)continue;throw e}e.appendChild(t)}e.replaceWith(...e.childNodes)}processFunc(e){const t=e.getAttribute("name"),r=e.getAttribute("params")?e.getAttribute("params").split(",").map((e=>e.trim())):[],s=e.cloneNode(!0),i=new Map([...this.scopes.flatMap((e=>[...e.entries()]))]);this.functions.set(t,{params:r,body:s,closedScope:i}),e.remove()}async processCall(e){const t=e.getAttribute("func"),r=e.getAttribute("args"),s=e.getAttribute("var"),i=this.functions.get(t);if(!i)throw new Error(`Function ${t} not found`);const o=r?this.evaluate(`[${r}]`):[];if(o.length!==i.params.length)throw new Error("Argument count mismatch");const a=this.scopes;this.scopes=[new Map(i.closedScope)],i.params.forEach(((e,t)=>this.setVariable(e,o[t])));const n=i.body.cloneNode(!0);let c;await this.processChildren(n);const l=n.querySelectorAll("return");Array.from(l).forEach((e=>{const t=e.getAttribute("expression");c=this.evaluate(t),e.remove()})),s?(this.setVariable(s,c),e.remove()):e.replaceWith(...n.childNodes),this.scopes=a}async processScope(e){this.scopes.push(new Map),await this.processChildren(e),e.replaceWith(...e.childNodes),this.scopes.pop()}processInput(e){const t=e.getAttribute("var"),r=e.getAttribute("prompt")||"",s=prompt(r);this.setVariable(t,s),e.remove()}processOutput(e){const t=e.getAttribute("expression"),r=this.evaluate(t);e.innerText=r.toString()}async processTry(e){const t=e.nextElementSibling&&"catch"===e.nextElementSibling.tagName.toLowerCase()?e.nextElementSibling:null,r=t&&t.getAttribute("var")||"e";try{await this.processChildren(e),e.replaceWith(...e.childNodes),t&&t.remove()}catch(s){if(e.remove(),!t)throw s;this.setVariable(r,s),await this.processChildren(t),t.replaceWith(...t.childNodes)}}async processImport(e){const t=e.getAttribute("src"),r=e.getAttribute("type")||"script",s=e.getAttribute("namespace");try{const i=await fetch(t),o=await i.text();if(s&&this.scopes.push(new Map),"module"===r){const e=await import(t);this.setVariable(s||"imported",e)}else if("script"===r)new Function(o)();else if("html"===r){const t=document.createElement("div");t.innerHTML=o,await this.processChildren(t),e.replaceWith(...t.childNodes)}s&&this.scopes.pop()}catch(e){console.error(`Import failed from ${t}:`,e)}e.remove()}processOn(e){const t=e.getAttribute("event"),r=e.getAttribute("selector"),s=e.cloneNode(!0);e.remove();document.querySelectorAll(r).forEach((e=>{e.addEventListener(t,(async e=>{this.scopes.push(new Map),this.setVariable("event",e);const t=s.cloneNode(!0);await this.processChildren(t),this.scopes.pop()}))}))}processDebug(e){const t=e.getAttribute("var");t?console.dir(this.getVariable(t)):console.log("Debug point reached",(new Error).stack),e.remove()}async processHttp(e){const t=e.getAttribute("method")?.toUpperCase()||"GET",r=e.getAttribute("url"),s=e.getAttribute("headers"),i=e.getAttribute("body"),o=e.getAttribute("var");try{const a=s?this.evaluate(s):{},n=i?JSON.stringify(this.evaluate(i)):null,c={method:t,headers:a,body:"GET"!==t&&"HEAD"!==t?n:null},l=await fetch(r,c);let h;h=l.headers.get("content-type")?.includes("application/json")?await l.json():await l.text(),o?(this.setVariable(o,h),e.remove()):e.innerText=JSON.stringify(h)}catch(t){console.error("HTTP request failed:",r,t),o?(this.setVariable(o,{error:t.message}),e.remove()):e.innerText=`Error: ${t.message}`}}processJson(e){const t=e.getAttribute("var"),r=e.getAttribute("action")||"parse",s=e.getAttribute("source")||e.innerText.trim();try{let i;if("parse"===r)i=JSON.parse(s);else{if("stringify"!==r)throw new Error("Invalid JSON action");{const e=this.evaluate(s);i=JSON.stringify(e)}}t?(this.setVariable(t,i),e.remove()):e.innerText=i.toString()}catch(r){console.error("JSON processing error:",r),t?(this.setVariable(t,{error:r.message}),e.remove()):e.innerText=`Error: ${r.message}`}}processCsv(e){const t=e.getAttribute("var"),r=e.getAttribute("action")||"parse",s=e.getAttribute("source")||e.innerText.trim();try{let i;if("parse"===r){i=s.split("\n").map((e=>e.split(",").map((e=>e.trim()))))}else{if("stringify"!==r)throw new Error("Invalid CSV action");{let e=this.evaluate(s);if(!Array.isArray(e))throw new Error("CSV stringify requires an array");if(e.length>0&&"object"==typeof e[0]){const t=Object.keys(e[0]),r=[t.join(",")];e.forEach((e=>{r.push(t.map((t=>e[t]??"")).join(","))})),i=r.join("\n")}else i=e.map((e=>e.join(","))).join("\n")}}t?(this.setVariable(t,i),e.remove()):e.innerText=i.toString()}catch(r){console.error("CSV processing error:",r),t?(this.setVariable(t,{error:r.message}),e.remove()):e.innerText=`Error: ${r.message}`}}processIni(e){const t=e.getAttribute("var"),r=e.getAttribute("action")||"parse",s=e.getAttribute("source")||e.innerText.trim();try{let i;if("parse"===r){const e={};let t=null;s.split("\n").forEach((r=>{if((r=r.trim())&&!r.startsWith(";")&&!r.startsWith("#"))if(r.match(/^\[.*\]$/))t=r.slice(1,-1),e[t]={};else if(r.includes("=")&&t){const[s,i]=r.split("=").map((e=>e.trim()));e[t][s]=i}})),i=e}else{if("stringify"!==r)throw new Error("Invalid INI action");{const e=this.evaluate(s),t=[];for(const[r,s]of Object.entries(e)){t.push(`[${r}]`);for(const[e,r]of Object.entries(s))t.push(`${e}=${r}`)}i=t.join("\n")}}t?(this.setVariable(t,i),e.remove()):e.innerText=i.toString()}catch(r){console.error("INI processing error:",r),t?(this.setVariable(t,{error:r.message}),e.remove()):e.innerText=`Error: ${r.message}`}}processXml(e){const t=e.getAttribute("var"),r=e.getAttribute("action")||"parse",s=e.getAttribute("source")||e.innerText.trim();try{let i;if("parse"===r){const e=(new DOMParser).parseFromString(s,"application/xml");if(e.querySelector("parsererror"))throw new Error("Invalid XML");i=this.xmlToObject(e.documentElement)}else{if("stringify"!==r)throw new Error("Invalid XML action");{const e=this.evaluate(s);i=this.objectToXml(e)}}t?(this.setVariable(t,i),e.remove()):e.innerText=i.toString()}catch(r){console.error("XML processing error:",r),t?(this.setVariable(t,{error:r.message}),e.remove()):e.innerText=`Error: ${r.message}`}}xmlToObject(e){const t={name:e.tagName};if(e.attributes){t.attributes={};for(const r of e.attributes)t.attributes[r.name]=r.value}if(1===e.childNodes.length&&3===e.childNodes[0].nodeType)t.text=e.childNodes[0].textContent.trim();else{t.children=[];for(const r of e.childNodes)1===r.nodeType&&t.children.push(this.xmlToObject(r))}return t}objectToXml(e,t="root"){let r=`<${t=e.name||t}`;if(e.attributes)for(const[t,s]of Object.entries(e.attributes))r+=` ${t}="${s}"`;if(r+=">",e.text)r+=e.text;else if(e.children)for(const t of e.children)r+=this.objectToXml(t);return r+=`</${t}>`,r}processYml(e){const t=e.getAttribute("var"),r=e.getAttribute("action")||"parse",s=e.getAttribute("source")||e.innerText.trim();try{let i;if("parse"===r)i=this.parseYml(s);else{if("stringify"!==r)throw new Error("Invalid YML action");{const e=this.evaluate(s);i=this.stringifyYml(e)}}t?(this.setVariable(t,i),e.remove()):e.innerText=i.toString()}catch(r){console.error("YML processing error:",r),t?(this.setVariable(t,{error:r.message}),e.remove()):e.innerText=`Error: ${r.message}`}}parseYml(e){const t=e.split("\n"),r=[];let s={},i=s,o=0;return t.forEach(((e,t)=>{if(""===e.trim()||e.trim().startsWith("#"))return;const a=e.match(/^\s*/)[0].length,n=e.trim();if(a<o){for(let e=0;e<(o-a)/2;e++)r.pop();i=r[r.length-1]||s}else if(a>o&&a-o!=2)throw new Error("Invalid indentation at line "+(t+1));if(o=a,n.startsWith("-")){const e=n.slice(1).trim();if(Array.isArray(i)){const t=i[i.length-1];if(e.includes(":")){const[r,s]=e.split(":").map((e=>e.trim()));t[r]=this.parseYmlValue(s)}else i.push(this.parseYmlValue(e))}else{const t=[];i=t,r[r.length-1][Object.keys(r[r.length-1])[Object.keys(r[r.length-1]).length-1]]=t,r.push(t),t.push(this.parseYmlValue(e))}}else{if(!n.includes(":"))throw new Error("Invalid YAML syntax at line "+(t+1));{const[e,t]=n.split(":").map((e=>e.trim())),s=this.parseYmlValue(t);if(void 0===s){const t={};i[e]=t,r.push(i),i=t}else i[e]=s}}})),s}parseYmlValue(e){if(""!==e)return isNaN(e)?"true"===e||"false"!==e&&(e.startsWith('"')&&e.endsWith('"')?e.slice(1,-1):e):Number(e)}stringifyYml(e,t=0){let r="";const s=" ".repeat(t);for(const[i,o]of Object.entries(e))Array.isArray(o)?(r+=`${s}${i}:\n`,o.forEach((e=>{r+="object"==typeof e?`${s}  - \n${this.stringifyYml(e,t+4)}`:`${s}  - ${e}\n`}))):r+="object"==typeof o&&null!==o?`${s}${i}:\n${this.stringifyYml(o,t+2)}`:`${s}${i}: ${o}\n`;return r}init(){document.addEventListener("DOMContentLoaded",(async()=>{await this.processAll()}))}}class CustomBreakError extends Error{constructor(){super("break")}}class CustomContinueError extends Error{constructor(){super("continue")}}const htmlScript=new HtmlScript;
